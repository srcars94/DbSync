using System;
using System.Data.SqlClient;
using System.IO;
using Microsoft.SqlServer.Dac;

namespace DbSyncTool
{
    class Program
    {
        static void Main(string[] args)
        {
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            string sqlProjName = "YourDatabaseProject";
            string dbName = "YourLocalDb";
            string dacpacPath = Path.Combine(baseDir, sqlProjName, "bin", "Debug", $"{sqlProjName}.dacpac");
            string connectionString = $"Server=localhost;Database={dbName};Trusted_Connection=True;";
            string logPath = Path.Combine(baseDir, "logs", $"deploy-{dbName}-{DateTime.Now:yyyyMMdd-HHmmss}.log");
            string localDataScriptPath = Path.Combine(baseDir, "LocalDataSync.sql");

            Directory.CreateDirectory(Path.GetDirectoryName(logPath));
            Log(logPath, $"Starting sync to {dbName}");

            if (!File.Exists(dacpacPath))
            {
                Log(logPath, $"ERROR: DACPAC not found at {dacpacPath}");
                return;
            }

            try
            {
                var dacServices = new DacServices(connectionString);
                dacServices.Message += (s, e) => Log(logPath, e.Message);

                var options = new DacDeployOptions
                {
                    BlockOnPossibleDataLoss = false,
                    DropObjectsNotInSource = false,
                    IgnorePermissions = true,
                    IgnoreRoleMembership = true
                };

                // Set SQLCMD variables (these match what's referenced in the .sqlproj)
                DacDeployOptions deployOptions = new DacDeployOptions();
                var sqlCmdVars = new Dictionary<string, string>
                {
                    { "BusinessPortalsAcceptence", "BusinessPortalsAcceptence" },
                    { "SharedDb", "SharedDb" }
                };

                Log(logPath, "Deploying DACPAC...");
                var dacpac = DacPackage.Load(dacpacPath);
                dacServices.Deploy(dacpac, dbName, true, options, sqlCmdVars);
                Log(logPath, "Deployment complete.");

                // Optional: Dev-only data script
                if (dbName.ToLower().Contains("local") || dbName.ToLower().Contains("dev"))
                {
                    if (File.Exists(localDataScriptPath))
                    {
                        Log(logPath, "Running LocalDataSync.sql...");
                        string sql = File.ReadAllText(localDataScriptPath);
                        using (var conn = new SqlConnection(connectionString))
                        using (var cmd = new SqlCommand(sql, conn))
                        {
                            conn.Open();
                            cmd.ExecuteNonQuery();
                        }
                        Log(logPath, "Local data sync complete.");
                    }
                    else
                    {
                        Log(logPath, "LocalDataSync.sql not found. Skipping.");
                    }
                }
                else
                {
                    Log(logPath, $"Skipping local data sync (dbName = {dbName})");
                }
            }
            catch (Exception ex)
            {
                Log(logPath, $"ERROR: {ex.Message}");
            }

            Log(logPath, "Sync completed.");
        }

        static void Log(string path, string message)
        {
            string entry = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] {message}";
            Console.WriteLine(entry);
            File.AppendAllText(path, entry + Environment.NewLine);
        }
    }
}