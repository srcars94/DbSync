using AutoMapper;
using Microsoft.Extensions.Logging;

var scopeFactory = app.Services.GetRequiredService<IServiceScopeFactory>();
using (var scope = scopeFactory.CreateScope())
{
    var logger = scope.ServiceProvider.GetRequiredService<ILoggerFactory>()
                                      .CreateLogger("AutoMapperValidation");
    var cfg = scope.ServiceProvider.GetRequiredService<IConfigurationProvider>();

    try
    {
        // Validates all maps eagerly
        cfg.AssertConfigurationIsValid();
    }
    catch (AutoMapperConfigurationException ex)
    {
        foreach (var err in ex.Errors)
        {
            logger.LogError(
                "AutoMapper error: {Message}\n  Profile: {Profile}\n  Map: {Src} -> {Dest}\n  MemberPath: {Member}",
                err.ErrorMessage,
                err.TypeMap?.Profile?.ProfileName,
                err.Types?.SourceType,
                err.Types?.DestinationType,
                err.MemberPath
            );
        }

        // Optional: also log all loaded profiles
        if (cfg is MapperConfiguration mc)
        {
            var profiles = string.Join(", ", mc.Profiles.Select(p => p.ProfileName));
            logger.LogError("Loaded profiles: {Profiles}", profiles);
        }

        throw; // keep the failure so you see it in the browser
    }
}